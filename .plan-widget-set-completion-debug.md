# Debug Widget Set Completion UI Update Issue

## Problem
When sets are completed via the Live Activity widget, the exercise card header shows the correct completed count, but the individual set rows still appear incomplete (checkmark not filled).

## Investigation Steps

### 1. Add Comprehensive Debug Logging
Add logging to `syncPendingSetCompletionFromWidget()` to trace the entire flow:
- Log when pending completion is found
- Log the set ID being searched for
- Log which exercise and set index are found
- Log the values being applied
- Log the before/after state of the set's `completedAt`

### 2. Verify State Updates
Check if the issue is with:
- **Data update**: Set is being updated in the model but UI not refreshing
- **ID mismatch**: Widget is sending wrong set ID
- **Timing**: Update happening but being overwritten
- **SwiftUI reactivity**: Nested struct mutation not triggering view update

### 3. Potential Root Causes

#### Cause A: SwiftUI Not Detecting Nested Changes
`WorkoutSessionModel` is a struct with nested arrays. SwiftUI might not detect changes when we mutate:
```swift
workoutSession.updateExercises(updatedExercises)
```

**Fix**: Force SwiftUI to recognize the change by reassigning the entire state:
```swift
var updated = workoutSession
updated.updateExercises(updatedExercises)
workoutSession = updated
```

#### Cause B: Exercise/Set Arrays Are Immutable
The `exercises` property is `private(set)` which creates a new array reference.

**Check**: Verify `updateExercises` is actually mutating correctly by logging array pointers or IDs.

#### Cause C: Widget Sending Wrong Set ID
The widget might be sending a stale set ID that doesn't match current workout state.

**Fix**: Add validation logging to see if set IDs match.

#### Cause D: Update Being Overwritten
The periodic save or another update might be overwriting the widget completion.

**Check**: Add timestamp logging to see if multiple updates are happening.

### 4. Debugging Code to Add

```swift
func syncPendingSetCompletionFromWidget() {
    guard let pending = SharedWorkoutStorage.pendingSetCompletion else { return }
    
    print("üîç Widget Completion: Found pending for set '\(pending.setId)'")
    print("   Values: weight=\(pending.weightKg ?? 0)kg, reps=\(pending.reps ?? 0)")
    
    guard let exerciseIndex = workoutSession.exercises.firstIndex(where: { exercise in
        exercise.sets.contains { $0.id == pending.setId }
    }) else {
        print("‚ùå Widget Completion: Set not found in any exercise")
        print("   Available set IDs: \(workoutSession.exercises.flatMap { $0.sets.map { $0.id } })")
        SharedWorkoutStorage.clearPendingSetCompletion()
        return
    }
    
    print("‚úì Found in exercise \(exerciseIndex): '\(workoutSession.exercises[exerciseIndex].name)'")
    
    guard let setIndex = workoutSession.exercises[exerciseIndex].sets.firstIndex(where: { $0.id == pending.setId }) else {
        print("‚ùå Set ID matched but not found in sets array")
        SharedWorkoutStorage.clearPendingSetCompletion()
        return
    }
    
    print("‚úì Found at set index \(setIndex)")
    
    let beforeComplete = workoutSession.exercises[exerciseIndex].sets[setIndex].completedAt
    print("   Before: completedAt=\(beforeComplete?.description ?? "nil")")
    
    // Update logic...
    
    print("   After: completedAt=\(updatedSet.completedAt?.description ?? "nil")")
    print("‚úÖ Widget Completion: Successfully updated")
}
```

### 5. Verification Tests

After adding logging, test:
1. Complete a set from widget
2. Check console for the debug flow
3. Identify where the issue occurs

## Expected Fix

Most likely **Cause A**: Need to reassign the entire `workoutSession` state variable to trigger SwiftUI reactivity:

```swift
var updated = workoutSession
updated.updateExercises(updatedExercises)
workoutSession = updated // This triggers SwiftUI update
```

