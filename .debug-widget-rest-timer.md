# Debug Widget Set Completion - Rest Timer Not Starting

## Problem
When completing a set from the Live Activity widget, the set is marked complete but the rest timer mechanics aren't triggered like they are when completing from the main app.

## Expected Behavior (Main App)
In `updateSet()` function (line ~322):
```swift
// Start a rest timer when a set transitions from incomplete -> complete
if previousCompletedAt == nil, updatedSet.completedAt != nil {
    let customForThisSet = restBeforeSetIdToSec[updatedSet.id]
    startRestTimer(durationSeconds: customForThisSet ?? restDurationSeconds)
}
```

## Current Widget Behavior
In `syncPendingSetCompletionFromWidget()` (line ~102):
- Updates the set and marks as complete
- Does NOT check for completion transition
- Does NOT call `startRestTimer()`
- Widget has already started its own rest timer, but main app doesn't know about it

## Investigation Points

### 1. Rest Timer Already Started by Widget
The widget's `CompleteSetIntent` already starts a rest timer:
```swift
let restEnd = Date().addingTimeInterval(TimeInterval(defaultRestDurationSeconds))
SharedWorkoutStorage.restEndTime = restEnd
```

Main app syncs this via `HKWorkoutManager.syncRestEndTimeFromSharedStorage()`.

**Question**: Is the issue that the rest timer IS starting but something else is off?

### 2. Missing Rest Timer Start
Or is the rest timer not starting at all from the widget completion?

**Check**: Does `syncRestEndTimeFromSharedStorage()` properly handle the widget-initiated rest?

### 3. Rest Timer Mechanics Incomplete
Perhaps the widget's rest timer is being set but other mechanics aren't working:
- Exercise auto-advance on completion?
- Rest notification?
- UI feedback?

## Potential Solutions

### Solution A: Let Widget's Rest Timer Work
The widget already starts the rest timer and writes to shared storage. Main app should:
1. Detect the rest timer via `syncRestEndTimeFromSharedStorage()`
2. NOT start another rest timer in `syncPendingSetCompletionFromWidget()`
3. Just ensure the rest end time is synced

**Verify**: Is `syncRestEndTimeFromSharedStorage()` being called and working?

### Solution B: Main App Starts Rest Timer
When processing widget completion, explicitly start the rest timer:
```swift
func syncPendingSetCompletionFromWidget() {
    // ... update set logic ...
    
    // Start rest timer (widget already set the end time, just sync it)
    if let restEnd = SharedWorkoutStorage.restEndTime {
        hkWorkoutManager.restEndTime = restEnd
        // Trigger any UI or notification mechanics
    }
}
```

### Solution C: Call updateSet Instead
Instead of directly updating, route through the existing `updateSet()` flow:
```swift
func syncPendingSetCompletionFromWidget() {
    // ... find the set ...
    
    var updatedSet = workoutSession.exercises[exerciseIndex].sets[setIndex]
    // Apply values
    updatedSet.completedAt = pending.completedAt
    
    // Use existing updateSet logic which handles rest timer
    updateSet(updatedSet, in: exercise.id)
    
    // Clear pending
    SharedWorkoutStorage.clearPendingSetCompletion()
}
```

This ensures all the same mechanics fire (rest timer, exercise advance, etc.).

## Recommended Fix

**Solution C** - Route through `updateSet()` to ensure consistent behavior.

Add to `syncPendingSetCompletionFromWidget()`:
```swift
// Apply values to the set
var updatedSet = updatedExercises[exerciseIndex].sets[setIndex]
if let weight = pending.weightKg { updatedSet.weightKg = weight }
if let reps = pending.reps { updatedSet.reps = reps }
if let distance = pending.distanceMeters { updatedSet.distanceMeters = distance }
if let duration = pending.durationSec { updatedSet.durationSec = duration }
updatedSet.completedAt = pending.completedAt

// Clear pending first to avoid reprocessing
SharedWorkoutStorage.clearPendingSetCompletion()

// Route through updateSet to trigger all mechanics (rest timer, exercise advance, etc.)
updateSet(updatedSet, in: workoutSession.exercises[exerciseIndex].id)
```

The rest timer from the widget will be overridden by the main app's timer, ensuring consistent behavior.

