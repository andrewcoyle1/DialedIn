# Fix Widget Completion Not Syncing on App Reopen

## Problem
When a user:
1. Backgrounds the app
2. Completes a set via Live Activity widget
3. Reopens the app and shows workout tracker
4. **UI shows stale state** (set still appears incomplete)
5. Dismisses and reopens tracker
6. **UI now correct** (set shows as complete)

## Root Cause
The workout tracker loads its state on initial `onAppear`, but:
- When app is backgrounded, the polling timer stops/suspends
- Widget completion is saved to SharedStorage
- When app comes to foreground, `onAppear` doesn't fire again (view already appeared)
- Tracker still has stale in-memory state
- When dismissed and reopened, `buildView()` runs and loads fresh data from local storage

## Solution Options

### Option A: Sync on Scene Phase Change
Listen for app returning to foreground using `.onChange(of: scenePhase)`:
```swift
@Environment(\.scenePhase) private var scenePhase

.onChange(of: scenePhase) { old, new in
    if new == .active && old == .background {
        // App returned to foreground, sync widget completions
        syncPendingSetCompletionFromWidget()
        // Also reload from local storage in case of other changes
        buildView()
    }
}
```

### Option B: Always Check on Appear
Modify `buildView()` to always check for pending widget completions:
```swift
internal func buildView() {
    // ... existing reload logic ...
    
    // Check for pending widget completions
    syncPendingSetCompletionFromWidget()
    
    // ... rest of buildView ...
}
```

### Option C: Check in Timer
Ensure the TimelineView periodic update triggers the sync even when backgrounded.

**Issue**: TimelineView updates are suspended when backgrounded, so this won't help.

## Recommended Solution

**Option A + B Combined**:
1. Add `scenePhase` monitoring to sync when returning to foreground
2. Also call `syncPendingSetCompletionFromWidget()` at the end of `buildView()`

This ensures:
- Immediate sync when view first appears
- Sync when app returns from background
- Robust coverage for all scenarios

## Implementation

### 1. Add Environment Variable
```swift
@Environment(\.scenePhase) private var scenePhase
```

### 2. Add Scene Phase Observer
```swift
.onChange(of: scenePhase) { oldPhase, newPhase in
    if newPhase == .active && oldPhase == .background {
        print("ðŸ“± App returned to foreground, syncing widget completions")
        syncPendingSetCompletionFromWidget()
    }
}
```

### 3. Call Sync in buildView()
At the end of `buildView()`, after expanding exercises:
```swift
// Check for pending widget completions that happened while backgrounded
syncPendingSetCompletionFromWidget()
```

This ensures coverage for both cold starts and returning from background.

